<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX Projects</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.8"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">GPX Projects</h1>
        
        <div id="login-section" class="mb-8">
            <a href="https://gpx.onrender.com/login" 
               class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-block">
                Login with GitHub
            </a>
        </div>
        
        <div id="projects-section" class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Your Projects</h2>
            <div id="projects" hx-get="https://gpx.onrender.com/projects" hx-trigger="load" hx-target="this">
                Loading projects...
            </div>
        </div>
        
        <div id="project-items-section" class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Project Items</h2>
            <select id="project-selector" class="mb-4 p-2 border rounded"
                    _="on change call fetchItems(my.value)">
                <option value="">Select a project</option>
            </select>
            <div id="project-items">
                Select a project to view items
            </div>
        </div>
        
        <div id="add-item-section" class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Add New Item</h2>
            <form hx-post="https://gpx.onrender.com/project/{projectId}/item"
                  hx-target="#project-items"
                  hx-swap="beforeend"
                  _="on submit set my.projectId to #project-selector.value">
                <input type="text" name="note" placeholder="Enter item note" 
                       class="p-2 border rounded mr-2" required>
                <button type="submit" 
                        class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    Add Item
                </button>
            </form>
        </div>
    </div>

    <script type="text/hyperscript">
        def fetchItems(projectId)
            set #project-items.innerHTML to "Loading items..."
            fetch(`https://gpx.onrender.com/project/${projectId}/items`)
                then response.json()
                then call displayItems(it)
        end

        def displayItems(data)
            set #project-items.innerHTML to ""
            for column in data
                set columnDiv to document.createElement("div")
                set columnDiv.className to "bg-gray-100 p-4 mb-4"
                set columnDiv.innerHTML to `<h4 class="text-md font-semibold">${column.column}</h4>`
                for item in column.items
                    set itemDiv to document.createElement("div")
                    set itemDiv.className to "bg-white shadow rounded p-2 mb-2"
                    set itemDiv.textContent to item.note
                    columnDiv.appendChild(itemDiv)
                end
                #project-items.appendChild(columnDiv)
            end
        end

        on htmx:afterOnLoad from #projects
            set projectsData to JSON.parse(#projects.textContent)
            set #projects.innerHTML to ""
            for project in projectsData
                set projectDiv to document.createElement("div")
                set projectDiv.className to "bg-white shadow rounded-lg p-4 mb-4"
                set projectDiv.innerHTML to `
                    <h3 class="text-lg font-semibold">${project.name}</h3>
                    <p>${project.body || ""}</p>
                `
                #projects.appendChild(projectDiv)

                set newOption to document.createElement("option")
                set newOption.textContent to project.name
                set newOption.value to project.id
                #project-selector.appendChild(newOption)
            end
        end
    </script>
</body>
</html>
